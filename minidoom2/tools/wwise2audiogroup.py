#!/usr/bin/env python3

from Klib.GMblob import GMaudiogroup
from pathlib import Path
import json
import sys

TXTP_DIR = Path("misc/txtp")
OUT_DIR = Path("assets")
EMPTY_AGRP = Path("misc/audiogroup1.dat")

# every switche values in gml_Object_objSoundController_Other_10.gml
musicevents=[3914262805, 1665218802, 3150908235, 2649652880, 633194145, 420599838, 2735867079, 4151003756, 67943629, 571130002, 3460068715, 3244528565, 4291064116, 1555752854, 3273719513, 1937780328, 4046732195, 2649652880]

# not in music event:
map1_play = 1167663857
map1_stop = 2460655527
map2_play = 417599375
map2_stop = 3176703629

# from gmwPostEvent-list.txt (without level_music and mapN_play/stop)
# cat ../gmwPostEvent-list.txt | grep gmwPostEvent | grep -v map | grep -v level|  cut -d'(' -f2| cut -d' ' -f1 | tr -d '\n'
listevents=[1769061634,1665166279,1329757545,712922669,3209240538,431031170,942769058,2706385482,1858919568,129291521,566396871,2724723684,838832574,838832574,838832574,838832574,181388086,2201946156,990924336,990924336,1912787390,1912787390,1912787390,1912787390,181388086,2083826353,3425129253,1927637741,1927637741,3834024670,2699813043,1582057048,1633792666,530129416,421030957,2032784644,3401202270,1489373806,839427473,2307334456,994762762,1343492921,3099727844,1147174287,345296488,345296491,345296493,345296490,345737775,345737772,345737770,345737773,345590710,345590709,345590708,345590707,345590706,345590704,345590705,2699813043,3165379571,3165379571,2699813043,612075679,612075679,4032190095,4032190095,127913177,2143083598,530129416,530129416,1080450575,2201105581,4088467408,2012126230,2012126230,3055091340,3834024670,3834024670,3114990154,3114990154,20509240,4186111119,4186111119,4218803221,4218803221,4186111119,3114990154,20509240,4186111119,4186111119,4186111119,4218803221,4218803221,3224296360,3224296360,1285677878,2177907266,3224296360,4088467408,4088467408,4088467408,566396871,4088467408,3001378473,1813586822,3243785053,3001378473,3001378473,1813586822,3243785053,3001378473,2557555811,309173761,4088467408,4088467408,3114990154,3114990154,2503030746,251847169,2503030746,1828931291,1828931291,3645869917,712922669,4088467408,2691847895,3255686181,3671582078,1362586229,1463591585,1602728877,2196351236,3215617638,421030957,309173761,1046718846,3834024670,210740095,210740095,1973032580,1526102535,1560169506,726041144,1049680431,3327910443,839427473,839427473,2055164935,3858291829,2503030746,2201946156,3858291829,3858291829,1576797514,3858291829,3858291829,3858291829,2075033040,2150209046,2533324748,1046718846,2150209046,1046718846,4063489072,3834024670,2720323380,3490057686,1725414132,1881393051,4088467408,430586528,3875421469,12495913,3875421469,2012126230,2012126230,3055091340,2012126230,2012126230,3055091340,860308699,3524882848,261204107,3524882848,430586528,2144418421,2144418421,2144418421,2144418421,2273048406,2273048406,20509240,430586528,2331601151,2331601151,2998807279,80751710,3921005316,80751710,994762762,324443136,324443136,324443136,3255686181,657815719,657815719,2023124656,657815719,2464161496,571191325,127913177,2464161496,571191325,75789304,127913177,1239331014,3131127885,1239331014,529197921,1239331014,1239331014,1046898251,1046898251,1046898251,2275742978,2464161496,3119023729,571191325,1771071041,1771071041,4088467408,4088467408,566396871,129291521,129291521,129291521,4088467408,4088467408,4088467408,4088467408,1183067778,1183067778,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,566396871,566396871,566396871,430586528,4088467408,4088467408,4088467408,4088467408,4088467408,1183067778,4088467408,4088467408,4088467408,4088467408,1183067778,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,4088467408,1183067778,1183067778,3834024670,3834024670,3834024670,3834024670,3255686181,1607748481,3209240538,309173761,1343492921,309173761,4166439457,39709115,398230851,1225032963,3094180764,3602287031,3602287031,3775912019,3098392326,60367361,3004208205,3004208205,3004208205,324443136,324443136,421030957,471570251,1617021868,3114990154,4047627580,3570572787,85764089,3114385261,2083826353,1927637741,1927637741,2196351236,3215617638,4088467408,2358190526,2083826353,1927637741,1927637741,154722495,931810011,3834024670,3834024670,3834024670,3834024670,3834024670,3834024670,2201946156,2549585788,3570572787,3570572787,3570572787,3570572787,3570572787,1526102535,3494105444,4088467408,530129416,530129416,530129416,530129416,3834024670,2344654491,3831467419,621107083,3834024670,3834024670,3834024670,3180209976,3834024670,3834024670,1617021868,3834024670,3834024670,3834024670,1617021868,324443136,1276247214,3643881547,324443136,3739772600,1343492921,309173761,3099727844,2347549329,321659273,1251273892,1251273892,1251273892,530129416,1329757546,3244528565,2632997667,2632997667,2632997667,2632997667,942769058,1769061634,1769061634,1769061634,1769061634,1665166276,1769061634,1769061634,1769061634,942769058,3425445029,3425445029,3425445029,1850388778,3425445029,1850388778,3425445029,3425445029,3425445029,3425445029,1769061634,1850388778,3425445029,3425445029,1850388778,1850388778,3425445029,1850388778,3425445029,1850388778,3425445029,3425445029,1769061634,1665166279,1665166279,1665166276,1665166279,1665166276,1665166276,1665166279,1665166279,1769061634,1769061634,1665166279,1665166276,1769061634,1665166279,1769061634,1665166279,1665166279,1769061634,1769061634,1665166276,1769061634,1769061634,1427248168,1427248169,1427248170,1427248171,1427248172,1427248173,1427248174,1427248175,1427248160,1427248161,3148029296,3148029297,3148029298,3148029299,3148029300,3148029301,3148029302,3148029303,3148029304,3148029305,3921005316,3909398768,3909398768,3909398768,3909398768,3909398768,3909398768,2292748373,2292748373,431031170,431031170,431031170,2055662663,3799482513,999524307,324443136,2278276480,860308699,324443136,2984764225,2236409707,1371364219,575017064,1853403813,1360719236,2663228079,3049631291,3436486759,2369751224,3050937518,2984764225,1521059325]

sounds = {}

with open(sys.argv[1]) as jsonfile:
    bankevents = json.load(jsonfile)
    for _,key in enumerate(bankevents.keys()):

        # We skip music for the moment, we process only SFX sound (not played in loop)
        if not int(bankevents[key]["eventid"]) in musicevents and int(bankevents[key]["switchid"]) == 0:
            # We process only SFX sound
            if int(bankevents[key]["eventid"]) in listevents:
                #print (f"{bankevents[key]["name"]} {bankevents[key]["txtp"]}")
                
                if not bankevents[key]["name"] in sounds.keys():
                    sounds[bankevents[key]["name"]] = { "txtp" : bankevents[key]["txtp"] }


audiogroup = GMaudiogroup( EMPTY_AGRP,3,0,1)

for i,key in enumerate(sorted(sounds.keys(),key=str.casefold)):
    audiogroup.import_sound_txtp(TXTP_DIR / sounds[key]["txtp"],1)

audiogroup.write_changes(OUT_DIR)
